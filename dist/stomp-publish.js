module.exports=function(e){var t={};function r(s){if(t[s])return t[s].exports;var n=t[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:s})},r.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r.w={},r(r.s=5)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{constructor(e={}){this.command=e.command||"",this.headers=e.headers||{},this.body=e.body||"",this.contentLength=-1}toString(){return JSON.stringify({command:this.command,headers:this.headers,body:this.body})}send(e){var t=this.command+"\n";for(var r in this.headers)t+=r+":"+this.headers[r]+"\n";return this.body.length>0&&(this.headers.hasOwnProperty("suppress-content-length")||(t+="content-length:"+Buffer.byteLength(this.body)+"\n")),t+="\n",this.body.length>0&&(t+=this.body),t+="\0",new Promise(r=>e.write(t,null,r))}setCommand(e){this.command=e}setHeader(e,t){this.headers[e]=t,"content-length"===e.toLowerCase()&&(this.contentLength=parseInt(t))}appendToBody(e){this.body+=e}validate(e){var t=Object.keys(this.headers);for(var r in e.headers){var s=e.headers[r];if(s.hasOwnProperty("required")&&!0===s.required&&-1===t.indexOf(r))return{isValid:!1,message:'Header "'+r+'" is required for '+this.command,details:"Frame: "+this.toString()};if(s.hasOwnProperty("regex")&&t.indexOf(r)>-1&&!this.headers[r].match(s.regex))return{isValid:!1,message:'Header "'+r+'" has value "'+this.headers[r]+'" which does not match against the following regex: '+s.regex+" (Frame: "+this.toString()+")"}}return{isValid:!0}}}},function(e,t){e.exports=require("events")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s,n=r(0),i=(s=n)&&s.__esModule?s:{default:s},a=r(1);const o={COMMAND:0,HEADERS:1,BODY:2,ERROR:3};t.default=class extends a.EventEmitter{constructor(e={}){super(...arguments),this.state=o.COMMAND,this.frame=new i.default,this.frames=[],this.buffer="",this.frameValidators=e,this.commands=Object.keys(e)}incrementState(){this.state===o.BODY||this.state===o.ERROR?this.state=o.COMMAND:this.state++}handleData(e){this.buffer+=e;do{this.state===o.COMMAND&&this.parseCommand(),this.state===o.HEADERS&&this.parseHeaders(),this.state===o.BODY&&this.parseBody(),this.state===o.ERROR&&this.parseError()}while(this.state===o.COMMAND&&this.hasLine())}hasLine(){return this.buffer.indexOf("\n")>-1}popLine(){var e=this.buffer.indexOf("\n"),t=this.buffer.slice(0,e);return this.buffer=this.buffer.substr(e+1),t}parseCommand(){for(;this.hasLine();){var e=this.popLine();if(""!==e){if(-1===this.commands.indexOf(e)){this.error({message:"No such command ",details:"Unrecognized Command '"+e+"'"});break}this.frame.setCommand(e),this.incrementState();break}}}parseHeaders(){for(;this.hasLine();){var e=this.popLine();if(""===e){this.incrementState();break}var t=e.split(":");if(t.length<2){this.error({message:"Error parsing header",details:'No ":" in line "'+e+'"'});break}this.frame.setHeader(t[0],t.slice(1).join(":"))}}parseBody(){var e=Buffer.from(this.buffer);if(this.frame.contentLength>-1){var t=this.frame.contentLength-this.frame.body.length;if(t<e.length){if(this.frame.appendToBody(e.slice(0,t).toString()),this.buffer=e.slice(t,e.length).toString(),this.frame.contentLength!==Buffer.byteLength(this.frame.body))return;this.frame.contentLength=-1}}var r=this.buffer.indexOf("\0");if(-1===r)this.frame.appendToBody(this.buffer),this.buffer="";else{this.frame.appendToBody(this.buffer.slice(0,r));var s=this.getFrameValidation(this.frame.command);s.isValid?(this.emit("frame",this.frame),this.emit(this.frame.command,this.frame)):this.emit("parseError",{message:s.message,details:s.details}),this.frame=new i.default,this.incrementState(),this.buffer=this.buffer.substr(r+1)}}getFrameValidation(e){if(this.frameValidators.hasOwnProperty(e))return this.frame.validate(this.frameValidators[e]);this.emit("parseError",{message:"No validator defined for "+e})}}},function(e,t){e.exports=require("net")},function(e,t){e.exports=require("tls")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e},n=r(1),i=d(r(4)),a=d(r(3)),o=d(r(0)),h=d(r(2));function d(e){return e&&e.__esModule?e:{default:e}}var c={"1.0":{CONNECTED:{headers:{session:{required:!0}}},MESSAGE:{headers:{destination:{required:!0},"message-id":{required:!0}}},ERROR:{},RECEIPT:{}},1.1:{CONNECTED:{headers:{session:{required:!0}}},MESSAGE:{headers:{destination:{required:!0},"message-id":{required:!0}}},ERROR:{},RECEIPT:{}}};const u=(e,t)=>{return 1!==t.length||"string"==typeof e?(e=>{let[t,r,s,n,i,a,o,h]=e;return!0===h&&(h={}),{address:t,port:r,user:s,pass:n,protocolVersion:i,vhost:a,reconnectOpts:o,tlsOpts:h}})(t):(e=>{let{address:t,port:r,user:s,pass:n,protocolVersion:i,vhost:a,reconnectOpts:o,tls:h}=e;return t||(t=e.host),{address:t,port:r,user:s,pass:n,protocolVersion:i,vhost:a,reconnectOpts:o,tlsOpts:!0===h?e:e.tls}})(e)};class m extends n.EventEmitter{constructor(e){super(...arguments);const{address:t,port:r,user:s,pass:n,protocolVersion:i,vhost:a,reconnectOpts:o,tlsOpts:d}=u(e,arguments);if(this.version=i||"1.0",!c[this.version])throw new Error("STOMP version "+this.version+" is not supported");return this.user=s||"",this.pass=n||"",this.address=t||"127.0.0.1",this.port=r||61613,this.subscriptions={},this._stompFrameEmitter=new h.default(c[this.version]),this.vhost=a||null,this.reconnectOpts=o||{},this.tls=d,this._retryNumber=0,this._retryDelay=this.reconnectOpts.delay,this}connect(e,t){var r,s=this;return delete this._disconnectCallback,t&&s.on("error",t),this.tls?(s.stream=i.default.connect(s.port,s.address,this.tls),r="secureConnect"):(s.stream=a.default.createConnection(s.port,s.address),r="connect"),s.stream.on(r,s.onConnect.bind(this)),s.stream.on("error",function(e){process.nextTick(function(){s._stompFrameEmitter.removeAllListeners()}),s._retryNumber<s.reconnectOpts.retries?(0===s._retryNumber&&s.emit("reconnecting"),s._reconnectTimer=setTimeout(function(){s.connect()},s._retryNumber++*s.reconnectOpts.delay)):(s._retryNumber===s.reconnectOpts.retries&&(e.message+=" [reconnect attempts reached]",e.reconnectionFailed=!0),s.emit("error",e))}),e&&s.on("connect",e),this}disconnect(e){var t=this;return t._reconnectTimer&&clearTimeout(t._reconnectTimer),this.stream&&(this._disconnectCallback=e||function(){},new o.default({command:"DISCONNECT"}).send(this.stream),process.nextTick(function(){t.stream.end()})),this}onConnect(){var e=this,t=e._stompFrameEmitter;e.stream.on("data",function(e){t.handleData(e)}),e.stream.on("end",function(){e._disconnectCallback?e._disconnectCallback():e.stream.emit("error",new Error("Server has gone away"))}),t.on("MESSAGE",function(t){var r=e.subscriptions[t.headers.destination];r&&r.listeners.map(function(e){e(t.body,t.headers)}),e.emit("message",t.body,t.headers)}),t.on("CONNECTED",function(t){e._retryNumber>0?(e.emit("reconnect",t.headers.session,e._retryNumber),e._retryNumber=0):e.emit("connect",t.headers.session)}),t.on("ERROR",function(t){var r=new Error(t.headers.message);Object.assign(r,t.headers),e.emit("error",r,t.body)}),t.on("parseError",function(t){var r=new Error(t.message);t.details&&(r.details=t.details),e.emit("error",r),e.stream.destroy()});var r={login:e.user,passcode:e.pass};for(var s in this.vhost&&"1.1"===this.version&&(r.host=this.vhost),new o.default({command:"CONNECT",headers:r}).send(e.stream),e.subscriptions)new o.default({command:"SUBSCRIBE",headers:e.subscriptions[s].headers}).send(e.stream)}publish(e,t,r,n){return(r=s({},r)).destination=e,new o.default({command:"SEND",headers:r,body:t}).send(this.stream)}}Object.defineProperty(m.prototype,"writable",{get:function(){return this.stream&&this.stream.writable}}),t.default=m}]);
//# sourceMappingURL=stomp-publish.js.map